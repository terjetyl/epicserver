@{
    ViewBag.Title = "Map";
}

<h2>Map</h2>

<script src="/Scripts/jquery.signalR-0.5.1.min.js" type="text/javascript"></script>
<script src="/signalr/hubs" type="text/javascript"></script>

<script src="http://maps.google.com/maps/api/js?sensor=false">
</script>

<style type="text/css">
    #mapContainer {
        height: 500px;
        width: 100%;
        float: left;
    }
</style>

<div class="span12">

    <div id="mypos">
        <h3>My position</h3>
        Lat: <span data-bind="text: lat"></span>
        <br />
        Lng: <span data-bind="text: lng"></span>
    </div>

    <div id="mapContainer"></div>

</div>
<script type="text/javascript">

    $(function() {

        var positionViewModel = function(map, hub) {
            var self = this;
            self.lat = ko.observable();
            self.lng = ko.observable();
            self.name = ko.observable("Terje");
            self.map = map;

            self.coords = ko.computed(function() {
                return new google.maps.LatLng(self.lat(), self.lng());
            }, self);

            self.marker = ko.computed(function() {
                return new google.maps.Marker({
                    position: self.coords(),
                    map: self.map,
                    title: self.name()
                });
            }, self);

            self.startTracking = function() {
                setInterval(function() {
                    self.updateLocation();
                }, 5000);
            };
            
            self.updateLocation = function() {
                console.log('updateLocation');
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        self.lat(position.coords.latitude);
                        self.lng(position.coords.longitude);
                        hub.updateLocation({ "Name": "Terje", "Latitude": self.lat(), "Longitude": self.lng() });
                    });
                }
            };
        };


        if (navigator.geolocation) {

            navigator.geolocation.getCurrentPosition(function (position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;

                var coords = new google.maps.LatLng(latitude, longitude);

                var mapOptions = {
                    zoom: 15,
                    center: coords,
                    mapTypeControl: true,
                    navigationControlOptions: {
                        style: google.maps.NavigationControlStyle.SMALL
                    },
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                map = new google.maps.Map(
                    document.getElementById("mapContainer"), mapOptions
                );

                var hub = $.connection.locationHub;
                
                var vm = new positionViewModel(map, hub);
                ko.applyBindings(vm);

                hub.say = function (location) {
                    console.log('say');
                    vm.lat(location.Latitude);
                    vm.lng(location.Longitude);
                };
                
                $.connection.hub.start().done(function () {
                    console.log('connected');
                    vm.startTracking();
                });
            });
        } else {
            alert("Geolocation API is not supported in your browser.");
        };
    });
</script>
