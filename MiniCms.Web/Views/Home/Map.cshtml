@{
    ViewBag.Title = "Map";
}

<h2>Map</h2>

<script src="/Scripts/jquery.signalR.js" type="text/javascript"></script>
<script src="/signalr/hubs" type="text/javascript"></script>

<script src="http://maps.google.com/maps/api/js?sensor=false">
</script>

<style type="text/css">
    #mapContainer {
        height: 500px;
        width: 100%;
        float: left;
    }
</style>

<div class="span12">

    <div id="mypos">
        <h3>My position</h3>
        Lat: <span data-bind="text: lat"></span>
        <br />
        Lng: <span data-bind="text: lng"></span>
    </div>

    <div id="mapContainer"></div>

</div>
<script type="text/javascript">
    var connected = false;
    $.connection.hub.start(function () {
        console.log('connected');
        connected = true;
    });

    var positionViewModel = function (map) {
        var self = this;
        self.lat = ko.observable();
        self.lng = ko.observable();
        self.name = ko.observable("Terje");
        self.map = map;
        self.hub = $.connection.locationHub;
        
        self.hub.say = function (value) {
            self.lat(value.Latitude);
            self.lng(value.Longitude);
        };

        self.postlocation = function () {
            if (connected == true) {
                $.connection.locationHub.updateLocation({ "Name": "Terje", "Latitude": self.lat(), "Longitude": self.lng() });
            }
        };
        self.coords = ko.computed(function () {
            return new google.maps.LatLng(self.lat(), self.lng());
        }, self);

        self.marker = ko.computed(function () {
            self.postlocation();
            return new google.maps.Marker({
                position: self.coords(),
                map: self.map,
                title: self.name()
            });
        }, self);
        
        

        self.tracklocation = ko.observable(true);

        self.updateLocation = function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    self.lat(position.coords.latitude);
                    self.lng(position.coords.longitude);
                });
            }
        };

        self.startTracking = function () {
            window.setInterval(function () {
                self.updateLocation();
            }, 5000);
        };
    };

    if (navigator.geolocation) {

        navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            var coords = new google.maps.LatLng(latitude, longitude);

            var mapOptions = {
                zoom: 15,
                center: coords,
                mapTypeControl: true,
                navigationControlOptions: {
                    style: google.maps.NavigationControlStyle.SMALL
                },
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(
                document.getElementById("mapContainer"), mapOptions
            );

            var vm = new positionViewModel(map);
            ko.applyBindings(vm);
            vm.startTracking();
        });
    } else {
        alert("Geolocation API is not supported in your browser.");
    }

</script>
